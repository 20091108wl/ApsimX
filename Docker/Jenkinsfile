pipeline {
    agent none 
    stages {
        stage('Build') {
			agent {
				dockerfile {
					filename 'Dockerfile.build'
					dir 'Docker'
					additionalBuildArgs '-t buildapsimx -m 16g --cpu-count %NUMBER_OF_PROCESSORS%'
				}
			}
            steps {
                bat 'call C:\\BuildTools\\Common7\\Tools\\VsDevCmd.bat'
				bat 'set apsimx=C:\\ApsimX'
				bat 'cd %apsimx%'
				bat 'nuget restore'
				bat 'copy /y %apsimx%\\DeploymentSupport\\Windows\\Bin64\\* %apsimx%\\Bin'
				bat 'msbuild /m %apsimx%\\ApsimX.sln'
            }
        }
    }
}